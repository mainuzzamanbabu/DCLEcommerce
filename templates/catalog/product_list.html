{% extends 'base.html' %}
{% load static %}

{% block title %}{% if category %}{{ category.name }}{% else %}All Products{% endif %} | DCL E-Commerce{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header py-4 animate-fadeIn" style="background: var(--dark); position: relative; overflow: hidden; padding-top: 4rem !important; border-bottom: 1px solid rgba(255,255,255,0.05);">
    <div class="position-absolute inset-0" style="background: var(--gradient-mesh); opacity: 0.15; pointer-events: none;"></div>
    <div class="container py-4 position-relative z-1">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}" class="text-white-50 text-decoration-none hover-white">Home</a></li>
                {% if category %}
                <li class="breadcrumb-item"><a href="{% url 'catalog:product_list' %}" class="text-white-50 text-decoration-none hover-white">Products</a></li>
                <li class="breadcrumb-item active text-white fw-medium">{{ category.name }}</li>
                {% else %}
                <li class="breadcrumb-item active text-white fw-medium">All Products</li>
                {% endif %}
            </ol>
        </nav>
        <h1 class="text-white mb-2 fw-bold display-5">{% if category %}{{ category.name }}{% else %}Catalog{% endif %}</h1>
        <p class="text-white-50 mb-0 max-w-500">Explore our premium selection of technology and electronics crafted for performance.</p>
    </div>
</section>

<!-- Products Section -->
<section class="section py-4 bg-light-subtle">
    <div class="container">
        <div class="row">
            <!-- Sidebar Filters -->
            <div class="col-lg-3 filter-sidebar-col">
                <div class="filter-sidebar glass-card rounded-4 p-4 shadow-sm mb-4 mb-lg-0 sticky-top" style="top: 100px; z-index: 10;">
                    
                    <!-- Price Range -->
                    <div class="filter-group mb-4">
                        <h6 class="filter-title d-flex justify-content-between align-items-center mb-3 fw-bold text-dark">
                            Price Range
                        </h6>
                        <div class="price-range-slider px-2">
                            <form id="price-filter-form">
                                <input type="range" class="form-range" id="priceRange" 
                                       min="{{ min_price_range }}" max="{{ max_price_range }}" 
                                       value="{{ current_filters.max_price|default:max_price_range }}"
                                       oninput="document.getElementById('max_price_input').value = this.value">
                                <div class="d-flex justify-content-between align-items-center mt-2 gap-2">
                                    <input type="number" name="min_price" class="form-control form-control-sm text-center" 
                                           value="{{ current_filters.min_price|default:min_price_range }}" placeholder="Min">
                                    <span class="text-muted">-</span>
                                    <input type="number" name="max_price" id="max_price_input" class="form-control form-control-sm text-center" 
                                           value="{{ current_filters.max_price|default:max_price_range }}" placeholder="Max">
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm w-100 mt-2 rounded-pill">Apply</button>
                            </form>
                        </div>
                    </div>

                    <hr class="text-secondary opacity-10 my-4">

                    <!-- Availability -->
                    <div class="filter-group mb-4">
                        <h6 class="filter-title d-flex justify-content-between align-items-center mb-3 fw-bold text-dark" data-bs-toggle="collapse" data-bs-target="#availabilityCollapse">
                            Availability <i class="bi bi-chevron-down fs-xs"></i>
                        </h6>
                        <div class="collapse show" id="availabilityCollapse">
                            <div class="form-check custom-checkbox mb-2">
                                <input class="form-check-input availability-checkbox" type="checkbox" id="in_stock" value="1" {% if current_filters.in_stock %}checked{% endif %}>
                                <label class="form-check-label text-dark-secondary small" for="in_stock">In Stock</label>
                            </div>
                            <div class="form-check custom-checkbox mb-2">
                                <input class="form-check-input availability-checkbox" type="checkbox" id="pre_order" value="1">
                                <label class="form-check-label text-dark-secondary small" for="pre_order">Pre Order</label>
                            </div>
                            <div class="form-check custom-checkbox mb-2">
                                <input class="form-check-input availability-checkbox" type="checkbox" id="up_coming" value="1">
                                <label class="form-check-label text-dark-secondary small" for="up_coming">Up Coming</label>
                            </div>
                        </div>
                    </div>

                    <hr class="text-secondary opacity-10 my-4">

                    <!-- Series / Categories -->
                    <div class="filter-group mb-4">
                         <h6 class="filter-title d-flex justify-content-between align-items-center mb-3 fw-bold text-dark" data-bs-toggle="collapse" data-bs-target="#seriesCollapse">
                            Categories <i class="bi bi-chevron-down fs-xs"></i>
                        </h6>
                        <div class="collapse show" id="seriesCollapse" style="max-height: 200px; overflow-y: auto;">
                            {% for cat in nav_categories %}
                            <div class="form-check custom-checkbox mb-2">
                                <input class="form-check-input category-checkbox" type="checkbox" 
                                       id="cat-{{ cat.slug }}" 
                                       {% if category and category.slug == cat.slug %}checked{% endif %}>
                                <label class="form-check-label text-dark-secondary small" for="cat-{{ cat.slug }}">
                                    {{ cat.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <hr class="text-secondary opacity-10 my-4">

                    <!-- Brand -->
                    <div class="filter-group">
                        <h6 class="filter-title d-flex justify-content-between align-items-center mb-3 fw-bold text-dark" data-bs-toggle="collapse" data-bs-target="#brandCollapse">
                            Brand <i class="bi bi-chevron-down fs-xs"></i>
                        </h6>
                        <div class="collapse show" id="brandCollapse" style="max-height: 200px; overflow-y: auto;">
                            {% for brand in brands %}
                            <div class="form-check custom-checkbox mb-2">
                                <input class="form-check-input brand-checkbox" type="checkbox" 
                                       id="brand-{{ brand.slug }}" 
                                       value="{{ brand.slug }}"
                                       {% if current_filters.brand == brand.slug %}checked{% endif %}>
                                <label class="form-check-label text-dark-secondary small" for="brand-{{ brand.slug }}">
                                    {{ brand.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div class="col-lg-9">
                <!-- Toolbar -->
                <div class="products-toolbar bg-white p-3 rounded-4 mb-4 shadow-sm border border-light">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                        <h5 class="mb-0 fw-bold text-dark">{% if category %}{{ category.name }}{% else %}All Products{% endif %}</h5>
                        
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-muted small">Show:</span>
                                <select class="form-select form-select-sm border-0 bg-light rounded-pill px-3" style="width: auto;">
                                    <option value="20">20</option>
                                    <option value="40">40</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-muted small">Sort By:</span>
                                <select class="form-select form-select-sm border-0 bg-light rounded-pill px-3" id="sort-select" style="min-width: 120px;">
                                    <option value="default">Default</option>
                                    <option value="price_low" {% if current_filters.sort == 'price_low' %}selected{% endif %}>Price (Low > High)</option>
                                    <option value="price_high" {% if current_filters.sort == 'price_high' %}selected{% endif %}>Price (High > Low)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Products Grid Container -->
                <div id="product-grid-container" style="min-height: 400px; position: relative;">
                    <!-- Loading Overlay -->
                    <div id="grid-loader" class="position-absolute top-0 start-0 w-100 h-100 d-none justify-content-center align-items-start pt-5" 
                         style="background: rgba(255,255,255,0.7); z-index: 100; backdrop-filter: blur(4px);">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                    
                    {% include 'catalog/partials/_product_grid.html' %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceForm = document.getElementById('price-filter-form');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
    const sortSelect = document.getElementById('sort-select');
    const gridLoader = document.getElementById('grid-loader');
    const productCountText = document.querySelector('#product-count span');
    
    // Function to fetch and update grid
    function updateGrid(url) {
        const gridContainer = document.getElementById('product-grid-container');
        if (!gridContainer) return;
        
        // Show loader
        if (gridLoader) {
            gridLoader.classList.remove('d-none');
            gridLoader.classList.add('d-flex');
        }
        
        fetch(url, {
            headers: { 'x-requested-with': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Update grid
            const newGrid = doc.getElementById('product-grid') || doc.querySelector('#product-grid');
            const currentGrid = document.getElementById('product-grid');
            
            if (newGrid && currentGrid) {
                // Ensure visibility immediately for AJAX content
                newGrid.querySelectorAll('.product-card').forEach(card => {
                    card.style.opacity = '1';
                    card.style.transform = 'none';
                    card.classList.add('animated'); 
                });
                
                currentGrid.replaceWith(newGrid);
                console.log('Grid replaced and forced visible');
            }
            
            // Re-sync product count - robust search in new fragments
            // Try both finding in the doc and in the new grid fragment
            const newCountInput = doc.querySelector('#ajax-product-count') || newGrid.querySelector('#ajax-product-count');
            const newCountVal = newCountInput ? newCountInput.value : null;
            const countDisplay = document.querySelector('#product-count .text-dark.fw-bold');
            
            console.log('DEBUG: Found new count input:', !!newCountInput, 'Value:', newCountVal);

            if (newCountVal !== null && countDisplay) {
                countDisplay.textContent = newCountVal;
                // Update pluralization label
                const countLabel = document.getElementById('product-count-label');
                if (countLabel) {
                    countLabel.textContent = parseInt(newCountVal) === 1 ? 'product' : 'products';
                }
            }

            // Sync URL
            window.history.pushState({}, '', url);
            
            // Refresh animations
            if (typeof initScrollAnimations === 'function') initScrollAnimations();
            
            // Re-apply view mode if list view is active
            const currentListViewBtn = document.getElementById('list-view');
            if (currentListViewBtn && currentListViewBtn.classList.contains('active')) {
                const targetGrid = document.getElementById('product-grid');
                if (targetGrid) targetGrid.classList.add('view-list');
                console.log('List view re-applied after AJAX');
            }
        })
        .catch(error => {
            console.error('AJAX Error:', error);
            if (typeof showNotification === 'function') showNotification('Update failed', 'error');
        })
        .finally(() => {
            if (gridLoader) {
                gridLoader.classList.add('d-none');
                gridLoader.classList.remove('d-flex');
            }
        });
    }

    // Clear All AJAX
    const clearAllBtn = document.getElementById('clear-all-filters'); // Corrected ID
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Reset checkboxes
            document.querySelectorAll('.category-checkbox, .brand-checkbox, #in_stock, #featured').forEach(cb => cb.checked = false);
            // Reset price
            document.querySelectorAll('#price-filter-form input').forEach(input => input.value = '');
            // Update grid to default URL
            updateGrid(this.getAttribute('href'));
        });
    }

    // Build URL helper
    function getFilterUrl() {
        // Use full catalog path as base for current filter building
        const url = new URL("{% url 'catalog:product_list' %}", window.location.origin);
        const params = url.searchParams;
        
        if (sortSelect.value) params.set('sort', sortSelect.value);
        
        // Category - handle as search param for consistency in collective filtering
        const selectedCat = document.querySelector('.category-checkbox:checked');
        if (selectedCat) {
            // Extract slug from ID if data-url doesn't help with direct slug
            const slug = selectedCat.id.replace('cat-', '');
            params.set('category', slug); 
        }
        
        // Price
        const minPrice = priceForm.querySelector('input[name="min_price"]').value;
        const maxPrice = priceForm.querySelector('input[name="max_price"]').value;
        if (minPrice) params.set('min_price', minPrice);
        if (maxPrice) params.set('max_price', maxPrice);
        
        // Brand
        const selectedBrand = document.querySelector('.brand-checkbox:checked');
        if (selectedBrand) params.set('brand', selectedBrand.value);
        
        // Availability
        const inStock = document.querySelector('#in_stock:checked');
        if (inStock) params.set('in_stock', '1');
        
        const featured = document.querySelector('#featured:checked');
        if (featured) params.set('featured', '1');
        
        return url.toString();
    }

    // Listeners
    categoryCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => updateGrid(getFilterUrl()));
    });


    // Brand and Availability listeners
    document.querySelectorAll('.brand-checkbox, .availability-checkbox').forEach(cb => {
        cb.addEventListener('change', () => updateGrid(getFilterUrl()));
    });

    sortSelect.addEventListener('change', () => updateGrid(getFilterUrl()));
    
    if (priceForm) {
        priceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateGrid(getFilterUrl());
        });
    }

    // View Switcher Login
    const gridBtn = document.getElementById('grid-view');
    const listBtn = document.getElementById('list-view');
    const gridElement = document.getElementById('product-grid-container');

    if (gridBtn && listBtn) {
        gridBtn.addEventListener('click', () => {
            gridBtn.classList.add('active');
            gridBtn.classList.remove('text-muted');
            listBtn.classList.remove('active');
            listBtn.classList.add('text-muted');
            document.getElementById('product-grid').classList.remove('view-list');
        });

        listBtn.addEventListener('click', () => {
            listBtn.classList.add('active');
            listBtn.classList.remove('text-muted');
            gridBtn.classList.remove('active');
            gridBtn.classList.add('text-muted');
            document.getElementById('product-grid').classList.add('view-list');
        });
    }

    // Handle pagination clicks (AJAX)
    gridContainer.addEventListener('click', (e) => {
        const pageLink = e.target.closest('.page-link');
        if (pageLink && pageLink.getAttribute('href')) {
            e.preventDefault();
            updateGrid(pageLink.href);
            window.scrollTo({ top: 300, behavior: 'smooth' });
        }
    });
});
</script>
{% endblock %}


{% block extra_css %}
<style>
    .filter-sidebar { position: sticky; top: 100px; }
    .filter-title { cursor: pointer; transition: color 0.3s; }
    .filter-title:hover { color: var(--primary); }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
    .page-link { border: none; border-radius: 10px !important; margin: 0 4px; color: #444; transition: all 0.3s; }
    .page-link:hover, .page-item.active .page-link { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    /* Product Card Enhancements */
    .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 16px;
        overflow: hidden;
        background: white;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .product-image {
        position: relative;
        padding-top: 100%; /* 1:1 Aspect Ratio */
        overflow: hidden;
        background: #f8f9fa;
    }
    .product-image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    .product-card:hover .product-image img {
        transform: scale(1.05);
    }
    .product-overlay {
        position: absolute;
        bottom: -50px;
        left: 0;
        right: 0;
        padding: 15px;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        transition: bottom 0.3s ease;
        opacity: 0;
    }
    .product-card:hover .product-overlay {
        bottom: 0;
        opacity: 1;
    }
    .product-info {
        padding: 1.25rem;
    }
    .product-category {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    .product-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        height: 2.8em; /* 2 lines */
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-clamp: 2; /* Added for compatibility */
    }
    .product-price {
        display: flex;
        align-items: baseline;
        gap: 8px;
    }
    .current-price {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
    }
    .original-price {
        font-size: 0.9rem;
        text-decoration: line-through;
        color: #adb5bd;
    }
    .product-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
        z-index: 2;
    }
    .badge-sale { background: #ef4444; }
    .badge-new { background: #3b82f6; }
    
    .wishlist-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #dc3545;
        z-index: 2;
        opacity: 0;
        transform: translateX(10px);
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .product-card:hover .wishlist-btn {
        opacity: 1;
        transform: translateX(0);
    }
    .wishlist-btn:hover {
        background: #dc3545;
        color: white;
    }
</style>
{% endblock %}
