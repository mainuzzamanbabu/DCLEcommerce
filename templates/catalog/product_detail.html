{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} | DCL E-Commerce{% endblock %}

{% block meta_description %}{{ product.name }} - {{ product.description|truncatewords:20 }}{% endblock %}

{% block navbar_class %}navbar-solid{% endblock %}

{% block content %}
<!-- Spacer for fixed navbar -->
<div style="height: 80px;"></div>

<!-- Breadcrumb -->
<section class="py-4 bg-light">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'catalog:product_list' %}">Products</a></li>
                {% if product.category %}
                <li class="breadcrumb-item"><a href="{% url 'catalog:category_detail' product.category.slug %}">{{ product.category.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active">{{ product.name }}</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Product Detail -->
<section class="section py-5">
    <div class="container">
        <div class="row g-5">
            <!-- Product Gallery -->
            <div class="col-lg-6" data-animate="fade-right">
                <div class="product-gallery">
                    <div class="main-image-container position-relative mb-4 shadow-sm rounded-4 overflow-hidden">
                        {% with primary_image=product.primary_image %}
                        {% if primary_image %}
                        <img src="{{ primary_image.image.url }}" 
                             alt="{{ product.name }}" 
                             class="main-image img-fluid w-100"
                             id="mainProductImage" style="object-fit: cover; aspect-ratio: 1/1;">
                        {% else %}
                        <img src="https://images.unsplash.com/photo-1593642632559-0c6d3fc62b89?w=800" 
                             alt="{{ product.name }}" 
                             class="main-image img-fluid w-100"
                             id="mainProductImage" style="object-fit: cover; aspect-ratio: 1/1;">
                        {% endif %}
                        {% endwith %}
                        
                        {% if product.is_on_sale %}
                        <span class="product-badge badge-sale position-absolute top-0 start-0 m-3">-{{ product.discount_percent|default:"10" }}% OFF</span>
                        {% endif %}
                    </div>
                    {% if product.images.count > 1 %}
                    <div class="thumbnail-strip d-flex gap-3 overflow-auto pb-2">
                        {% for image in product.images.all %}
                        <img src="{{ image.image.url }}" alt="" class="thumbnail {% if image.is_primary %}active{% endif %} rounded-3" data-full="{{ image.image.url }}" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;">
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-6" data-animate="fade-left">
                <div class="product-detail-info">
                    {% if product.stock_status == 'in_stock' or True %}
                    <span class="badge bg-success mb-3"><i class="bi bi-check-circle me-1"></i>In Stock</span>
                    {% else %}
                    <span class="badge bg-danger mb-3"><i class="bi bi-x-circle me-1"></i>Out of Stock</span>
                    {% endif %}
                    <h1 class="product-title h2 fw-bold mb-3">{{ product.name }}</h1>
                    
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="rating text-warning">
                            <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-half"></i>
                        </div>
                        <span class="text-muted">({{ product.review_count|default:"0" }} reviews)</span>
                        <span class="text-muted">|</span>
                        <span class="text-muted">SKU: {{ product.sku|default:product.slug|upper }}</span>
                    </div>

                    <div class="price-section mb-4">
                        <div class="d-flex align-items-center gap-3">
                            <span class="current-price h2 fw-bold text-primary mb-0">৳{{ product.base_price|default:product.price|floatformat:0 }}</span>
                            {% if product.compare_at_price %}
                            <span class="original-price text-decoration-line-through text-muted h5 mb-0">৳{{ product.compare_at_price|floatformat:0 }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <p class="text-muted mb-4">{{ product.short_description|default:product.description|truncatewords:50 }}</p>

                    <!-- Quantity & Add to Cart -->
                    <form method="post" action="{% url 'cart:cart_add' %}" id="add-to-cart-form">
                        {% csrf_token %}
                        <div class="d-flex flex-wrap gap-3 mb-4">
                            <div class="quantity-selector d-flex align-items-center border rounded-pill px-2">
                                <button type="button" class="btn btn-link link-dark qty-minus p-0 px-2" style="text-decoration: none;">−</button>
                                <input type="number" name="quantity" class="qty-input form-control border-0 text-center" value="1" min="1" max="10" style="width: 50px; background: transparent;">
                                <button type="button" class="btn btn-link link-dark qty-plus p-0 px-2" style="text-decoration: none;">+</button>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill flex-grow-1 px-4">
                                <i class="bi bi-bag-plus me-2"></i>Add to Cart
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-lg rounded-circle p-2 px-3 wishlist-btn" data-product-id="{{ product.id }}">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Product Features -->
                    <div class="product-features glass-card p-4 rounded-4 mt-4">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-truck text-primary fs-4"></i>
                                    <div>
                                        <small class="text-muted d-block">Free Delivery</small>
                                        <span class="fw-semibold small">Orders over ৳5000</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-shield-check text-success fs-4"></i>
                                    <div>
                                        <small class="text-muted d-block">Warranty</small>
                                        <span class="fw-semibold small">1 Year Official</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="product-tabs mt-5 pt-4">
            <ul class="nav nav-pills mb-4 gap-2" id="productTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#description">Description</button></li>
                <li class="nav-item"><button class="nav-link rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#specifications">Specifications</button></li>
            </ul>
            <div class="tab-content" id="productTabsContent">
                <div class="tab-pane fade show active" id="description">
                    <div class="glass-card p-4 rounded-4">
                        {{ product.description|safe }}
                    </div>
                </div>
                <div class="tab-pane fade" id="specifications">
                    <div class="glass-card p-4 rounded-4">
                        <table class="table table-borderless mb-0">
                            <tbody>
                                <tr><th width="200">Category</th><td>{{ product.category.name }}</td></tr>
                                <tr><th>Brand</th><td>{{ product.brand.name }}</td></tr>
                                {% if product.warranty_months %}
                                <tr><th>Warranty</th><td>{{ product.warranty_months }} Months</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Thumbnail Gallery
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.addEventListener('click', () => {
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active', 'border-primary'));
            thumb.classList.add('active', 'border-primary');
            document.getElementById('mainProductImage').src = thumb.dataset.full;
        });
    });
    
    // Quantity selector
    const qtyInput = document.querySelector('.qty-input');
    document.querySelector('.qty-minus').addEventListener('click', () => {
        if (qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1;
    });
    document.querySelector('.qty-plus').addEventListener('click', () => {
        if (qtyInput.value < 10) qtyInput.value = parseInt(qtyInput.value) + 1;
    });
</script>
{% endblock %}
