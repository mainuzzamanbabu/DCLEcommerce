{% extends 'dashboard/base.html' %}
{% load humanize %}

{% block dashboard_content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">T. Revenue</span>
            <div class="stat-icon text-primary"><i class="bi bi-wallet2"></i></div>
        </div>
        <div class="stat-value">৳{{ total_revenue|floatformat:0|intcomma }}</div>
        <div class="stat-trend text-success">
            <i class="bi bi-graph-up-arrow"></i> 14% 
            <span class="text-muted ms-1">vs last mo.</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Total Orders</span>
            <div class="stat-icon text-info"><i class="bi bi-cart-check"></i></div>
        </div>
        <div class="stat-value">{{ total_orders|intcomma }}</div>
        <div class="stat-trend text-success">
            <i class="bi bi-graph-up-arrow"></i> 8%
            <span class="text-muted ms-1">vs last mo.</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Active Products</span>
            <div class="stat-icon text-warning"><i class="bi bi-box-seam"></i></div>
        </div>
        <div class="stat-value">{{ total_products|intcomma }}</div>
        <div class="stat-trend text-info">
            <i class="bi bi-dash"></i> Steady
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">C. Customers</span>
            <div class="stat-icon text-danger"><i class="bi bi-people"></i></div>
        </div>
        <div class="stat-value">{{ total_customers|intcomma }}</div>
        <div class="stat-trend text-success">
            <i class="bi bi-graph-up-arrow"></i> 11%
            <span class="text-muted ms-1">vs last mo.</span>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="chart-grid">
    <!-- Revenue Chart -->
    <div class="chart-card">
        <div class="chart-header d-flex justify-content-between align-items-center">
            <h3 class="chart-title mb-0">Sales Analytics</h3>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Last 30 Days</button>
            </div>
        </div>
        <div class="chart-container" style="height: 300px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    
    <!-- Sales by Location -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Sales by Category</h3>
        </div>
        <div class="location-list">
            {% for label, data in category_summary %}
            <div class="location-item d-flex justify-content-between align-items-center py-2 mb-2">
                <span class="text-muted small">{{ label }}</span>
                <div class="d-flex align-items-center gap-2">
                    <div class="progress" style="width: 80px; height: 4px;">
                        <div class="progress-bar bg-primary" style="width: {{ data }}%;"></div>
                    </div>
                    <span class="fw-bold small" style="min-width: 30px;">{{ data }}%</span>
                </div>
            </div>
            {% empty %}
            <div class="text-muted text-center py-4 small">No data available</div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Recent Orders Section -->
<div class="table-card mt-4">
    <div class="table-header d-flex justify-content-between align-items-center">
        <h3 class="table-title mb-0">Recent Activity</h3>
        <a href="{% url 'dashboard:order_list' %}" class="btn btn-sm btn-link text-primary text-decoration-none fw-bold">View Reports <i class="bi bi-arrow-right ms-1"></i></a>
    </div>
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th><input type="checkbox" class="form-check-input"></th>
                    <th>Reference</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td><input type="checkbox" class="form-check-input"></td>
                    <td class="fw-bold text-dark">#{{ order.order_number }}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle me-2 bg-light text-primary fw-bold" style="width: 24px; height: 24px; font-size: 10px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--admin-gray-200);">
                                {{ order.user.username|default:order.guest_email|slice:":1"|upper }}
                            </div>
                            <span class="text-muted small">
                                {% if order.user %}
                                    {{ order.user.get_full_name|default:order.user.email|truncatechars:20 }}
                                {% else %}
                                    {{ order.guest_full_name|default:"Guest"|truncatechars:20 }}
                                {% endif %}
                            </span>
                        </div>
                    </td>
                    <td class="text-muted small">{{ order.created_at|date:"M d, Y" }}</td>
                    <td class="fw-bold">৳{{ order.total|floatformat:0|intcomma }}</td>
                    <td>
                        <span class="status-badge 
                            {% if order.status == 'delivered' %}success
                            {% elif order.status == 'shipped' %}info
                            {% elif order.status == 'processing' %}warning
                            {% elif order.status == 'cancelled' %}danger
                            {% else %}info{% endif %}">
                            <i class="bi bi-dot me-0"></i>{{ order.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <a href="{% url 'dashboard:order_detail' order.order_number %}" class="action-btn" title="View Detail">
                            <i class="bi bi-arrow-right-short fs-4"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-receipt-cutoff display-6 d-block mb-2 opacity-25"></i>
                            <p class="small mb-0">No recent orders to show.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const salesLabels = JSON.parse(document.getElementById('sales-labels').textContent);
        const salesData = JSON.parse(document.getElementById('sales-data').textContent);

        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const gradient = revenueCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(79, 70, 229, 0.1)');
        gradient.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: salesLabels,
                datasets: [{
                    label: 'Revenue',
                    data: salesData,
                    borderColor: '#4f46e5',
                    backgroundColor: gradient,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderWidth: 2,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#1e293b',
                        padding: 10,
                        titleFont: { size: 12 },
                        bodyFont: { size: 12 },
                        displayColors: false
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 11 } }
                    },
                    y: {
                        border: { display: false },
                        grid: { color: '#f1f5f9' },
                        ticks: { 
                            color: '#94a3b8', 
                            font: { size: 11 },
                            callback: function(value) { return '৳' + (value >= 1000 ? (value/1000) + 'k' : value); }
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}
